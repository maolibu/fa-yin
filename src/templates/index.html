{% extends "base.html" %}
{% block title %}Ê≥ïÂç∞ÂØπÁÖß ¬∑ È¶ñÈ°µ{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/lib/leaflet.css">
<link rel="stylesheet" href="/static/css/lib/MarkerCluster.css">
<link rel="stylesheet" href="/static/css/lib/MarkerCluster.Default.css">
{% endblock %}

{% block scripts %}
<script src="/static/js/lib/d3.min.js"></script>
<script src="/static/js/lib/leaflet.js"></script>
<script src="/static/js/lib/leaflet.markercluster.js"></script>
<script src="/static/js/lib/split.min.js"></script>
<script src="/static/js/lib/lucide.min.js"></script>
<script src="/static/js/lib/sortable.min.js"></script>
<script src="/static/js/lineage.js"></script>
{% endblock %}

{% block content %}


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     Ë≠¶Á≠ñÂçÄÂüü ‚Äî ÊØèÊó•‰∏ÄÂÅàÔºàÂèØÁøªÈñ±„ÄÅËá™È°å„ÄÅÁΩÆÈ†ÇÔºâ
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="search-hero" x-data="verseApp()" x-init="init()">
    <div class="section-header">
        <h2 class="section-title">
            <div class="section-icon icon-jue" title="Ë¶∫"></div>
            Ë≠¶Á≠ñ
            <span class="section-subtitle">ÊôùÂ§úÊèêÊíï</span>
        </h2>
    </div>
    <div class="verse-card">
        <div class="verse-card-content">
            <!-- ÂÅàÈ¢ÇÊ≠£Êñá -->
            <blockquote class="verse-card-body">
                <template x-for="(line, li) in currentVerse.lines" :key="li">
                    <p x-text="line"></p>
                </template>
            </blockquote>
            <!-- Âá∫Â§Ñ -->
            <cite class="verse-card-source">
                <span x-text="currentVerse.source"></span>
                <span class="verse-custom-badge" x-show="currentVerse.type === 'custom'" x-cloak>‚úé Ëá™È°å</span>
            </cite>
            <!-- Â∑•ÂÖ∑Âàó -->
            <div class="verse-toolbar">
                <button class="verse-tool-btn" @click="prevVerse()" title="‰∏ä‰∏ÄÂÅà">
                    <i data-lucide="chevron-left" style="width:16px;height:16px"></i>
                </button>
                <span class="verse-counter" x-show="!editingCounter" @click="startEditCounter()" title="ÈªûÊìäËº∏ÂÖ•Â∫èËôü"
                    style="cursor:pointer" x-text="(currentIndex + 1) + ' / ' + verses.length"></span>
                <input class="verse-counter-input" x-show="editingCounter" x-cloak type="number" min="1"
                    :max="verses.length" x-model="counterInput" @keydown.enter="jumpToVerse()"
                    @keydown.escape="editingCounter = false" @blur="editingCounter = false" x-ref="counterInput">
                <button class="verse-tool-btn" @click="nextVerse()" title="‰∏ã‰∏ÄÂÅà">
                    <i data-lucide="chevron-right" style="width:16px;height:16px"></i>
                </button>
                <span class="verse-toolbar-sep"></span>
                <button class="verse-tool-btn" :class="isPinned ? 'is-active' : ''" @click="togglePin()"
                    :title="isPinned ? 'ÂèñÊ∂àÁΩÆÈ†Ç' : 'Ë®≠ÁÇ∫‰ªäÊó•'">
                    <i data-lucide="pin" style="width:14px;height:14px"></i>
                </button>
                <button class="verse-tool-btn" @click="showAddModal = true" title="Ëá™È°åÂÅàÈ†å">
                    <i data-lucide="pen-line" style="width:14px;height:14px"></i>
                </button>
                <button class="verse-tool-btn verse-tool-delete" x-show="currentVerse.type === 'custom'" x-cloak
                    @click="deleteCurrentVerse()" title="Âà™Èô§Ê≠§ÂÅà">
                    <i data-lucide="trash-2" style="width:14px;height:14px"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê Ëá™È°åÂÅàÈ†åÂΩàÁ™ó ‚ïê‚ïê‚ïê -->
    <div class="verse-modal-overlay" x-show="showAddModal" x-cloak @click.self="showAddModal = false"
        x-transition:enter="fade-enter" x-transition:enter-start="fade-enter-start"
        x-transition:enter-end="fade-enter-end">
        <div class="verse-modal">
            <div class="verse-modal-header">
                <h3>Ëá™È°åÂÅàÈ†å</h3>
                <button class="verse-modal-close" @click="showAddModal = false">‚úï</button>
            </div>
            <div class="verse-modal-body">
                <label class="verse-label">ÂÅàÈ†åÊ≠£Êñá</label>
                <textarea class="verse-textarea" x-model="newVerseText" rows="4"
                    placeholder="ÊØèË°å‰∏ÄÂè•ÔºåÂ¶ÇÔºö&#10;Ë´∏ÊÉ°Ëé´‰ΩúÔºåÁúæÂñÑÂ•âË°å&#10;Ëá™Ê∑®ÂÖ∂ÊÑèÔºåÊòØË´∏‰ΩõÊïô"></textarea>
                <label class="verse-label">Âá∫Ëôï</label>
                <input class="verse-input" type="text" x-model="newVerseSource" placeholder="Â¶ÇÔºö„ÄäÊ≥ïÂè•Á∂ì„ÄãÊàñ Ëá™È°å"
                    @keydown.enter="addVerse()">
            </div>
            <div class="verse-modal-footer">
                <button class="verse-btn verse-btn-secondary" @click="showAddModal = false">ÂèñÊ∂à</button>
                <button class="verse-btn verse-btn-primary" @click="addVerse()"
                    :disabled="!newVerseText.trim() || !newVerseSource.trim()">È°åÂÅà</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="verse-toast" :class="toastVisible ? 'is-visible' : ''" x-text="toastMsg"></div>
</section>

<script>
function verseApp() {
    return {
        verses: [],
        currentIndex: {{ daily_index }},
        pinnedId: null,
        pinnedType: null,
        showAddModal: false,
        newVerseText: '',
        newVerseSource: '',
        toastMsg: '',
        toastVisible: false,
        editingCounter: false,
        counterInput: '',

        get currentVerse() {
            if (this.verses.length === 0) {
                return {
                    lines: {{ daily_verse.lines | tojson }},
                    source: {{ daily_verse.source | tojson }},
                    type: 'builtin', id: 0
                };
            }
            return this.verses[this.currentIndex] || this.verses[0];
        },

        get isPinned() {
            const v = this.currentVerse;
            return v && this.pinnedId === v.id && this.pinnedType === v.type;
        },

        async init() {
            try {
                const res = await fetch('/api/verses');
                const data = await res.json();
                this.verses = data.verses;
                this.currentIndex = data.daily_index;
                this.pinnedId = data.pinned_id;
                this.pinnedType = data.pinned_type;
            } catch (e) {
                console.error('ËºâÂÖ•ÂÅàÈ†åÂ§±Êïó', e);
            }
            this.$nextTick(() => { if (window.lucide) lucide.createIcons(); });
        },

        prevVerse() {
            if (this.verses.length === 0) return;
            this.currentIndex = (this.currentIndex - 1 + this.verses.length) % this.verses.length;
        },

        nextVerse() {
            if (this.verses.length === 0) return;
            this.currentIndex = (this.currentIndex + 1) % this.verses.length;
        },

        startEditCounter() {
            this.counterInput = this.currentIndex + 1;
            this.editingCounter = true;
            this.$nextTick(() => this.$refs.counterInput?.select());
        },

        jumpToVerse() {
            const n = parseInt(this.counterInput);
            if (n >= 1 && n <= this.verses.length) {
                this.currentIndex = n - 1;
            }
            this.editingCounter = false;
        },

        async togglePin() {
            const v = this.currentVerse;
            if (!v) return;
            try {
                const res = await fetch('/api/verses/pin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: v.id, type: v.type })
                });
                const data = await res.json();
                if (data.pinned) {
                    this.pinnedId = v.id;
                    this.pinnedType = v.type;
                    this.toast('Â∑≤ÁΩÆÈ†ÇÁÇ∫‰ªäÊó•ÂÅàÈ†å');
                } else {
                    this.pinnedId = null;
                    this.pinnedType = null;
                    this.toast('Â∑≤ÂèñÊ∂àÁΩÆÈ†Ç');
                }
            } catch (e) {
                this.toast('Êìç‰ΩúÂ§±Êïó');
            }
        },

        async addVerse() {
            if (!this.newVerseText.trim() || !this.newVerseSource.trim()) return;
            const lines = this.newVerseText.split('\n').filter(l => l.trim());
            try {
                const res = await fetch('/api/verses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lines, source: this.newVerseSource.trim() })
                });
                const data = await res.json();
                if (data.status === 'ok') {
                    this.verses.push(data.verse);
                    this.currentIndex = this.verses.length - 1;
                    this.newVerseText = '';
                    this.newVerseSource = '';
                    this.showAddModal = false;
                    this.toast('ÂÅàÈ†åÂ∑≤È°å');
                }
            } catch (e) {
                this.toast('È°åÂÅàÂ§±Êïó');
            }
        },

        async deleteCurrentVerse() {
            const v = this.currentVerse;
            if (!v || v.type !== 'custom') return;
            if (!confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§ÂÅàÈ†åÔºü')) return;
            try {
                const res = await fetch(`/api/verses/${v.id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.status === 'ok') {
                    this.verses = this.verses.filter(x => !(x.id === v.id && x.type === 'custom'));
                    if (this.currentIndex >= this.verses.length) {
                        this.currentIndex = Math.max(0, this.verses.length - 1);
                    }
                    this.toast('Â∑≤Âà™Èô§');
                }
            } catch (e) {
                this.toast('Âà™Èô§Â§±Êïó');
            }
        },

        toast(msg) {
            this.toastMsg = msg;
            this.toastVisible = true;
            setTimeout(() => { this.toastVisible = false; }, 2000);
        }
    };
}
</script>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     Ê°àÂ§¥ ‚Äî ÂèØËá™ÂÆö‰πâÁöÑÊ†∏ÂøÉ‰π¶Êû∂ÔºàÂÆåÊï¥ CRUD ‰∫§‰∫íÔºâ
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="desk-section" x-data="favoritesApp()">
    <div class="section-header" style="display:flex;align-items:center;justify-content:space-between;">
        <h2 class="section-title">
            <div class="section-icon icon-wen" title="ËÅû"></div>
            Ê°àÈ†≠
            <span class="section-subtitle">Èö®ÊñáÂÖ•ËßÄ</span>
        </h2>
        <div style="display:flex;gap:8px;align-items:center;">
            <button class="fav-edit-toggle" :class="editMode ? 'is-active' : ''" @click="toggleEditMode()"
                :title="editMode ? 'ÈÄÄÂá∫Á∑®ËºØ' : 'Á∑®ËºØÊ®°Âºè'">
                <span x-text="editMode ? '‚úì ÂÆåÊàê' : '‚úé Á∑®ËºØ'"></span>
            </button>
            <!-- ÊòæÁ§∫ÈöêËóèÊ®°ÂùóÊï∞ÈáèÊèêÁ§∫ -->
            <span class="fav-hidden-hint" x-show="hiddenCount > 0" x-cloak x-text="hiddenCount + ' ÂÄãÂ∑≤Èö±Ëóè'"></span>
        </div>
    </div>

    <div class="modules-grid" x-ref="modulesGrid">
        <template x-for="(mod, index) in modules" :key="mod.id">
            <div class="module-card" :class="'module-' + mod.color" x-show="mod.visible || editMode"
                :data-module-index="index">
                <!-- Ê®°ÂùóÊ†áÈ¢òÊ†è -->
                <div class="module-header-row">
                    <button class="module-header" @click="!editMode && toggleModuleCollapse(index)"
                        :aria-expanded="!mod.collapsed" :style="editMode ? 'cursor:default' : ''">
                        <i data-lucide="lamp-desk"
                            style="width:18px;height:18px;color:var(--text-secondary);flex-shrink:0;"></i>
                        <div class="module-title-group">
                            <!-- Ê®°ÂùóÂêçÔºöÁºñËæëÊ®°ÂºèÂèØÈáçÂëΩÂêç -->
                            <template x-if="editingId === 'mod_' + index + '_name'">
                                <input class="inline-edit-input" type="text" :id="'inline-edit-mod_' + index + '_name'"
                                    x-model="editingValue" @keydown.enter="confirmRename(index, null, 'name')"
                                    @keydown.escape="cancelEdit()" @blur="confirmRename(index, null, 'name')"
                                    @click.stop>
                            </template>
                            <template x-if="editingId !== 'mod_' + index + '_name'">
                                <span class="module-name" x-text="mod.name"
                                    @dblclick="editMode && startRename('mod_' + index + '_name', mod.name)"></span>
                            </template>

                            <!-- ÂâØÊ†áËØ≠ÔºöÁºñËæëÊ®°ÂºèÂèØÈáçÂëΩÂêç -->
                            <template x-if="editingId === 'mod_' + index + '_subtitle'">
                                <input class="inline-edit-input inline-edit-sub" type="text"
                                    :id="'inline-edit-mod_' + index + '_subtitle'" x-model="editingValue"
                                    @keydown.enter="confirmRename(index, null, 'subtitle')"
                                    @keydown.escape="cancelEdit()" @blur="confirmRename(index, null, 'subtitle')"
                                    @click.stop placeholder="ÂâØÊ®ôË™û">
                            </template>
                            <template x-if="editingId !== 'mod_' + index + '_subtitle'">
                                <span class="module-subtitle" x-text="mod.subtitle" x-show="mod.subtitle || editMode"
                                    @dblclick="editMode && startRename('mod_' + index + '_subtitle', mod.subtitle || '')"></span>
                            </template>
                        </div>
                        <span class="module-count" x-text="mod.children.length + ' È†Ö'"
                            x-show="mod.children.length > 0 && !editMode"></span>
                        <span class="module-chevron" :class="!mod.collapsed ? 'is-open' : ''" x-show="!editMode">
                            ‚ñæ
                        </span>
                    </button>
                    <!-- ÁºñËæëÊ®°ÂºèÂ∑•ÂÖ∑ÊåâÈíÆ -->
                    <div class="module-edit-tools" x-show="editMode" x-cloak>
                        <button class="mod-tool-btn mod-tool-rename"
                            @click="startRename('mod_' + index + '_name', mod.name)" title="ÈáçÊñ∞ÂëΩÂêç">‚úé</button>
                        <button class="mod-tool-btn mod-tool-hide" @click="toggleModuleVisibility(index)"
                            :title="mod.visible ? 'Èö±Ëóè' : 'È°ØÁ§∫'">
                            <span x-text="mod.visible ? 'üëÅ' : 'üëÅ‚Äçüó®'"></span>
                        </button>
                        <button class="mod-tool-btn mod-tool-delete" @click="deleteModule(index)"
                            title="Âà™Èô§Êõ∏Êû∂">‚úï</button>
                    </div>
                </div>

                <!-- Ê®°ÂùóÂÜÖÂÆπÔºàÁºñËæëÊ®°Âºè‰∏ãÂßãÁªàÂ±ïÂºÄÔºâ -->
                <div class="module-body" x-show="!mod.collapsed || editMode" x-cloak x-transition:enter="slide-enter"
                    x-transition:enter-start="slide-enter-start" x-transition:enter-end="slide-enter-end"
                    x-transition:leave="slide-leave" x-transition:leave-start="slide-leave-start"
                    x-transition:leave-end="slide-leave-end">

                    <!-- Á©∫Áä∂ÊÄÅ -->
                    <div class="module-empty" x-show="mod.children.length === 0 && showFolderInput !== index">
                        <p class="empty-hint">ÈªûÊìä <strong>Ôºã</strong> Âª∫Á´ãÊ¢µÁØãÊàñÊú¨Âç∑</p>
                        <p class="empty-sub">Âú®ÊêúÂ∞ãÊ¨ÑÊâæÂà∞Á∂ìÊñáÂæåÔºåÂèØÊî∂ËóèËá≥Êú¨Êõ∏Êû∂</p>
                    </div>

                    <!-- Êñá‰ª∂Â§πÂíåÁªèÊñáÂàóË°® -->
                    <template x-for="(child, ci) in mod.children" :key="child.id">
                        <div :data-child-index="ci">
                            <!-- Êñá‰ª∂Â§π -->
                            <template x-if="child.type === 'folder'">
                                <div class="folder-group">
                                    <div class="folder-header" @click="!editMode && toggleFolderCollapse(index, ci)"
                                        :style="editMode ? 'cursor:default' : 'cursor:pointer'">
                                        <span class="folder-chevron" :class="!child.collapsed ? 'is-open' : ''"
                                            x-show="!editMode">‚ñæ</span>
                                        <span class="folder-icon-sm"><i data-lucide="library"
                                                style="width:16px;height:16px"></i></span>
                                        <!-- Êñá‰ª∂Â§πÂêçÔºöÁºñËæëÊ®°ÂºèÂèåÂáªÂèØÈáçÂëΩÂêç -->
                                        <template x-if="editingId === 'folder_' + index + '_' + ci + '_name'">
                                            <input class="inline-edit-input" type="text"
                                                :id="'inline-edit-folder_' + index + '_' + ci + '_name'"
                                                x-model="editingValue" @keydown.enter="confirmRename(index, ci, 'name')"
                                                @keydown.escape="cancelEdit()" @blur="confirmRename(index, ci, 'name')"
                                                @click.stop>
                                        </template>
                                        <template x-if="editingId !== 'folder_' + index + '_' + ci + '_name'">
                                            <span x-text="child.name"
                                                @dblclick="editMode && startRename('folder_' + index + '_' + ci + '_name', child.name)"></span>
                                        </template>
                                        <span class="folder-count" x-text="child.children.length + ' ÈÉ®'"></span>
                                        <button class="item-delete-btn" x-show="editMode" x-cloak
                                            @click.stop="deleteFolder(index, ci)" title="Âà™Èô§Ê¢µÁØã">‚úï</button>
                                    </div>
                                    <div x-show="!child.collapsed || editMode" x-cloak x-transition:enter="slide-enter"
                                        x-transition:enter-start="slide-enter-start"
                                        x-transition:enter-end="slide-enter-end" x-transition:leave="slide-leave"
                                        x-transition:leave-start="slide-leave-start"
                                        x-transition:leave-end="slide-leave-end">
                                        <template x-for="(sutra, si) in child.children" :key="sutra.id">
                                            <div class="sutra-item-row">
                                                <a class="sutra-item" :href="'/read/' + sutra.id">
                                                    <span class="sutra-item-id" x-text="sutra.id"></span>
                                                    <span class="sutra-item-title" x-text="sutra.title"></span>
                                                </a>
                                                <button class="item-delete-btn" x-show="editMode" x-cloak
                                                    @click="deleteSutra(index, ci, si)" title="ÁßªÈô§">‚úï</button>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- Áõ¥Êé•ÁªèÊñá -->
                            <template x-if="child.type === 'sutra'">
                                <div class="sutra-item-row">
                                    <a class="sutra-item" :href="'/read/' + child.id">
                                        <span class="sutra-item-id" x-text="child.id"></span>
                                        <span class="sutra-item-title" x-text="child.title"></span>
                                    </a>
                                    <button class="item-delete-btn" x-show="editMode" x-cloak
                                        @click="deleteSutra(index, ci)" title="ÁßªÈô§">‚úï</button>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- Êñ∞Âª∫Êñá‰ª∂Â§πËæìÂÖ•Ê°Ü -->
                    <div class="new-folder-row" x-show="showFolderInput === index" x-cloak>
                        <span class="folder-icon-sm"><i data-lucide="library" style="width:16px;height:16px"></i></span>
                        <input class="inline-edit-input" type="text" placeholder="Ê¢µÁØãÂêçÁ®±"
                            :id="'new-folder-input-' + index" x-model="newFolderName"
                            @keydown.enter="createFolder(index)" @keydown.escape="cancelNewFolder()">
                        <button class="fav-btn-sm fav-btn-ok" @click="createFolder(index)">‚úì</button>
                        <button class="fav-btn-sm fav-btn-cancel" @click="cancelNewFolder()">‚úï</button>
                    </div>

                    <!-- Ê∑ªÂä†ÊåâÈíÆ + ÂºπÂá∫ËèúÂçï -->
                    <div class="module-add-wrapper" style="position:relative;">
                        <button class="module-add-btn" @click="openAddMenu(index)">
                            Ôºã Âä†ÂÖ•
                        </button>
                        <!-- Ê∑ªÂä†ËèúÂçï -->
                        <div class="add-menu" x-show="addMenuModule === index" x-cloak @click.outside="closeAddMenu()"
                            x-transition>
                            <button class="add-menu-item" @click="startNewFolder(index)">
                                <i data-lucide="library"
                                    style="width:14px;height:14px;vertical-align:-2px;margin-right:6px"></i> Êñ∞Â¢ûÊ¢µÁØã
                            </button>
                            <button class="add-menu-item" @click="openFavModal(index)">
                                <i data-lucide="book-open-text"
                                    style="width:14px;height:14px;vertical-align:-2px;margin-right:6px"></i> Âä†ÂÖ•Á∂ìÂç∑
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- ÊòæÁ§∫ÈöêËóèÁöÑÊ®°ÂùóÂàóË°®ÔºàÁºñËæëÊ®°Âºè‰∏ãÔºâ -->
    <div class="hidden-modules-hint" x-show="editMode && hiddenCount > 0" x-cloak>
        <small>Â∑≤Èö±ËóèÁöÑÊõ∏Êû∂ÊúÉÂú®Á∑®ËºØÊ®°Âºè‰∏ã‰ª•ÂçäÈÄèÊòéÈ°ØÁ§∫ÔºåÈÄÄÂá∫Á∑®ËºØÂæå‰∏çÂèØË¶ã„ÄÇ</small>
    </div>

    <!-- Êñ∞Âª∫ÂàÜÂå∫ÊåâÈíÆ -->
    <!-- ÊåâÈíÆÁªÑÔºöÊñ∞Âª∫‰π¶Êû∂ + ÂØºÂá∫Êï∞ÊçÆ -->
    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
        <button class="new-module-btn" @click="openNewModuleModal()" style="flex: 1;">
            Ôºã Êñ∞Â¢ûÊõ∏Êû∂
        </button>
        <a href="/api/user_data/export" target="_blank" class="new-module-btn"
            style="flex: 0 0 auto; width: auto; background: rgba(255,255,255,0.05); border-style: solid; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; color: var(--text-secondary);">
            <i data-lucide="download" style="width: 1.2em; height: 1.2em; margin-right: 0.5em;"></i>
            ÂÇô‰ªΩ
        </a>
    </div>

    <!-- ‚ïê‚ïê‚ïê Êñ∞Âª∫ÂàÜÂå∫ÂºπÁ™ó ‚ïê‚ïê‚ïê -->
    <div class="fav-modal-overlay" x-show="showNewModuleModal" x-cloak @click.self="showNewModuleModal = false"
        x-transition:enter="fade-enter" x-transition:enter-start="fade-enter-start"
        x-transition:enter-end="fade-enter-end" x-transition:leave="fade-leave"
        x-transition:leave-start="fade-leave-start" x-transition:leave-end="fade-leave-end">
        <div class="fav-modal">
            <div class="fav-modal-header">
                <h3>Êñ∞Â¢ûÊõ∏Êû∂</h3>
                <button class="fav-modal-close" @click="showNewModuleModal = false">‚úï</button>
            </div>
            <div class="fav-modal-body">
                <label class="fav-label">Êõ∏Êû∂ÂêçÁ®±</label>
                <input class="fav-input" type="text" id="new-module-name-input" x-model="newModule.name"
                    placeholder="Â¶ÇÔºöÁ¶™ÂÆóÈÉ®" @keydown.enter="createModule()">

                <label class="fav-label">ÂâØÊ®ôË™ûÔºàÈÅ∏Â°´Ôºâ</label>
                <input class="fav-input" type="text" x-model="newModule.subtitle" placeholder="Â¶ÇÔºöÁõ¥Êåá‰∫∫ÂøÉ"
                    @keydown.enter="createModule()">

                <label class="fav-label">È°èËâ≤</label>
                <div class="fav-color-picker">
                    <template x-for="c in colorOptions" :key="c.value">
                        <button class="color-dot" :class="newModule.color === c.value ? 'is-selected' : ''"
                            :style="'background:' + c.css" :title="c.label" @click="newModule.color = c.value"></button>
                    </template>
                </div>
            </div>
            <div class="fav-modal-footer">
                <button class="fav-btn fav-btn-secondary" @click="showNewModuleModal = false">ÂèñÊ∂à</button>
                <button class="fav-btn fav-btn-primary" @click="createModule()"
                    :disabled="!newModule.name.trim()">Âª∫Á´ã</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê Êî∂ËóèÁªèÊñáÂºπÁ™ó ‚ïê‚ïê‚ïê -->
    <div class="fav-modal-overlay" x-show="showFavModal" x-cloak @click.self="closeFavModal()"
        x-transition:enter="fade-enter" x-transition:enter-start="fade-enter-start"
        x-transition:enter-end="fade-enter-end" x-transition:leave="fade-leave"
        x-transition:leave-start="fade-leave-start" x-transition:leave-end="fade-leave-end">
        <div class="fav-modal fav-modal-lg">
            <div class="fav-modal-header">
                <h3>Âä†ÂÖ•Á∂ìÂç∑Ëá≥„Äå<span x-text="favTargetModule !== null ? modules[favTargetModule]?.name : ''"></span>„Äç</h3>
                <button class="fav-modal-close" @click="closeFavModal()">‚úï</button>
            </div>
            <div class="fav-modal-body">
                <!-- ÁõÆÊ†áÊñá‰ª∂Â§πÈÄâÊã© -->
                <div class="fav-target-row"
                    x-show="favTargetModule !== null && modules[favTargetModule]?.children.some(c => c.type === 'folder')">
                    <label class="fav-label">ÊîæÂÖ•Ê¢µÁØã</label>
                    <select class="fav-select" x-model="favTargetFolder">
                        <option :value="null">‚Äî Áõ¥Êé•ÊîæÂÖ•Êõ∏Êû∂Ê†πÁõÆÈåÑ ‚Äî</option>
                        <template
                            x-for="(child, fi) in (favTargetModule !== null ? modules[favTargetModule]?.children.filter(c => c.type === 'folder') : [])"
                            :key="fi">
                            <option
                                :value="favTargetModule !== null ? modules[favTargetModule]?.children.indexOf(child) : fi"
                                x-text="'üìñ ' + child.name"></option>
                        </template>
                    </select>
                </div>

                <!-- ÊêúÁ¥¢ -->
                <label class="fav-label">ÊêúÂ∞ãÁ∂ìÊñá</label>
                <input class="fav-input" type="text" id="fav-search-input" x-model="favSearchQuery"
                    placeholder="Ëº∏ÂÖ•Á∂ìËôüÊàñÁ∂ìÂêç‚Ä¶" @input.debounce.300ms="doFavSearch()">

                <!-- ÊêúÁ¥¢ÁªìÊûú -->
                <div class="fav-results" x-show="favSearchResults.length > 0">
                    <template x-for="r in favSearchResults" :key="r.sutra_id">
                        <div class="fav-result-item" @click="addSutraToTarget(r)">
                            <span class="fav-result-id" x-text="r.sutra_id"></span>
                            <span class="fav-result-title" x-text="r.title"></span>
                            <span class="fav-result-add">Ôºã</span>
                        </div>
                    </template>
                </div>
                <div class="fav-no-result"
                    x-show="favSearchQuery.length > 0 && favSearchResults.length === 0 && !favSearchLoading">
                    Êú™ÊâæÂà∞Áõ∏Á¨¶Á∂ìÊñá
                </div>
            </div>
            <div class="fav-modal-footer">
                <button class="fav-btn fav-btn-secondary" @click="closeFavModal()">ÈóúÈñâ</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê Toast ÊèêÁ§∫ ‚ïê‚ïê‚ïê -->
    <div class="fav-toast" :class="toastVisible ? 'is-visible' : ''" x-text="toastMsg"></div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     Âå∫Âüü ‚ë° ‚Äî Á•ñÂ∏àÔºàÊ≥ïËÑâÂõæÔºâ
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="content-section" id="lineage-section">
    <div class="section-header">
        <h2 class="section-title">
            <div class="section-icon icon-deng" title="ÁÅØ"></div>
            Á•ñÂ∏´
            <span class="section-subtitle">‰∫∫Â§©ÁúºÁõÆ</span>
        </h2>
    </div>

    <!-- ÊêúÁ¥¢Ê¨Ñ + Êé®Ëñ¶ ChipsÔºàÂêå‰∏ÄË°åÔºâ -->
    <div class="lineage-header">
        <div class="lineage-search-box">
            <input type="text" id="lineage-search-input" placeholder="ÊêúÂ∞ã‰∫∫Áâ©‚Ä¶" autocomplete="off">
            <div class="lineage-search-results" id="lineage-search-results"></div>
        </div>
        <div class="lineage-search-chips" id="lineage-search-chips">
            <span class="chip-group">
                <button class="chip" data-q="ÈáãËø¶ÁâüÂ∞º‰Ωõ">ÈáãËø¶ÁâüÂ∞º‰Ωõ</button>
                <button class="chip" data-q="Ëè©ÊèêÈÅîÊë©">ÈÅîÊë©</button>
                <button class="chip" data-q="ÁéÑÂ•ò">ÁéÑÂ•ò</button>
                <button class="chip" data-q="È≥©Êë©ÁæÖ‰ªÄ">ÁæÖ‰ªÄ</button>
                <button class="chip" data-q="Ë∂ôÂ∑û">Ë∂ôÂ∑û</button>
                <button class="chip" data-q="Â∏åÈÅã">ÈªÉÊ™ó</button>
                <button class="chip" data-q="ÂÆóÊù≤">Â§ßÊÖß</button>
                <button class="chip" data-q="ÂÖãÂã§">ÂúìÊÇü</button>
                <button class="chip" data-q="ËôõÈõ≤">ËôõÈõ≤</button>
                <button class="chip" data-q="ÊÖßÈÅ†">ÊÖßÈÅ†</button>
                <button class="chip" data-q="ÈÅìÂÆ£">ÈÅìÂÆ£</button>
                <button class="chip" data-q="Á™∫Âü∫">Á™∫Âü∫</button>
            </span>
            <span class="chip-group">
                <button class="chip chip-sect" data-founder="A003627">Ëá®Êøü</button>
                <button class="chip chip-sect" data-founder="A009489">ÊõπÊ¥û</button>
                <button class="chip chip-sect" data-founder="A003703">Èõ≤ÈñÄ</button>
                <button class="chip chip-sect" data-founder="A000174">Ê≥ïÁúº</button>
                <button class="chip chip-sect" data-founder="A001984">Ê∫à‰ª∞</button>
                <button class="chip chip-sect" data-founder="A004146">Ê•äÂ≤ê</button>
                <button class="chip chip-sect" data-founder="A003921">ÈªÉÈæç</button>
                <button class="chip chip-sect" data-founder="A010291">Áü≥È†≠</button>
                <button class="chip chip-sect" data-founder="A003623">Ê¥™Â∑û</button>
                <button class="chip chip-sect" data-founder="A009582">ÂåóÂÆó</button>
                <button class="chip chip-sect" data-founder="A001719">ÂçóÂÆó</button>
                <button class="chip chip-sect" data-founder="A003867">ÁâõÈ†≠</button>
                <button class="chip chip-sect" data-founder="A005612">Ëç∑Êæ§</button>
            </span>
        </div>
    </div>

    <!-- ===== ÂõõÈù¢Êùø‰ª™Ë°®Áõò ===== -->
    <main class="lineage-dashboard">
        <!-- ‚ì™ Â∑¶‰æßÔºöÁºñÂπ¥Êó∂Èó¥ËΩ¥ (320px) -->
        <aside id="panel-timeline" class="ln-panel">
            <div class="ln-panel-header">
                <h2><i data-lucide="scroll-text" class="ln-panel-icon"></i> Á∑®Âπ¥</h2>
                <div style="display:flex;gap:4px;align-items:center">
                    <button class="chr-tool-btn active" id="monk-all" onclick="setMonkFilter(null)">ÂÖ®</button>
                    <button class="chr-tool-btn" id="monk-monk" onclick="setMonkFilter('monk')">ÂÉß</button>
                    <button class="chr-tool-btn" id="monk-lay" onclick="setMonkFilter('lay')">ÈùûÂÉß</button>
                </div>
            </div>
            <div class="chronicle-scroll" id="chronicle-container"></div>
        </aside>

        <!-- Âè≥‰æßÂå∫Âüü -->
        <div class="ln-right-area">
            <!-- ‚ë† Âè≥‰∏äÔºö‰∫∫Áâ©ËØ¶ÊÉÖ (40%) -->
            <div id="panel-detail" class="ln-panel split-v">
                <div class="ln-panel-header">
                    <h2 id="detail-title"><i data-lucide="circle-user-round" class="ln-panel-icon"></i> ‰∫∫Áâ©</h2>
                </div>
                <div id="detail-content" class="ln-panel-body">
                    <div class="ln-empty-state">
                        <div class="icon"><i data-lucide="circle-user-round" style="width:36px;height:36px"></i></div>
                        <div>ÈªûÊìäÁØÄÈªûÊü•Áúã‰∫∫Áâ©Ë©≥ÊÉÖ</div>
                        <div class="hint">Êàñ‰ΩøÁî®ÊêúÂ∞ãÊ¨ÑÂ∞ãÊâæ</div>
                    </div>
                </div>
            </div>

            <!-- ‚ë° ‚ë¢ Âè≥‰∏ãÔºöÊ≥ïËÑâÂõæ + Âú∞Âõæ (60%) -->
            <div class="ln-bottom-split split-v">
                <div id="panel-lineage" class="ln-panel split-h">
                    <div class="ln-panel-header">
                        <h2><i data-lucide="git-branch" class="ln-panel-icon"></i> Ê≥ïËÑà</h2>
                        <div style="display:flex;gap:6px;align-items:center">
                            <button id="lineage-expand-btn" class="lineage-expand-btn" disabled><i data-lucide="search"
                                    style="width:12px;height:12px;vertical-align:middle"></i> ËøΩÊ∫Ø</button>
                            <button id="lineage-fullscreen-btn" class="lineage-expand-btn"
                                onclick="toggleLineageFullscreen()"><i data-lucide="maximize-2"
                                    style="width:12px;height:12px;vertical-align:middle"></i> ÂÖ®Ëû¢Âπï</button>
                        </div>
                    </div>
                    <div id="lineage-container" class="ln-panel-body">
                        <div class="ln-empty-state" id="lineage-empty">
                            <div class="icon"><i data-lucide="git-branch" style="width:36px;height:36px"></i></div>
                            <div>ÈÅ∏Êìá‰∫∫Áâ©Êü•ÁúãÊ≥ïËÑàÈóú‰øÇ</div>
                        </div>
                    </div>
                </div>
                <div id="panel-map" class="ln-panel split-h">
                    <div class="ln-panel-header">
                        <h2><i data-lucide="footprints" class="ln-panel-icon"></i> Ë°åË∑°</h2>
                        <div style="display:flex;gap:6px;align-items:center">
                            <button id="map-fullscreen-btn" class="lineage-expand-btn"
                                onclick="toggleMapFullscreen()"><i data-lucide="maximize-2"
                                    style="width:12px;height:12px;vertical-align:middle"></i> ÂÖ®Ëû¢Âπï</button>
                        </div>
                    </div>
                    <div id="map-container" class="ln-panel-body"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Áä∂ÊÄÅÊ†è -->
    <div class="lineage-status-bar">
        <div class="ln-stat"><i data-lucide="circle-user-round" class="ln-status-icon"></i> <span
                id="ln-stat-persons">0</span> ‰∫∫Áâ©</div>
        <div class="ln-stat"><i data-lucide="list-tree" class="ln-status-icon"></i> <span id="ln-stat-edges">0</span> Â∏´Êâø
        </div>
        <div class="ln-stat"><i data-lucide="map-pin" class="ln-status-icon"></i> <span id="ln-stat-places">0</span> Âú∞Èªû
        </div>
        <div class="ln-stat"><i data-lucide="book-open-text" class="ln-status-icon"></i> <span
                id="ln-stat-scriptures">0</span> Á∂ìÂÖ∏</div>
        <div class="ln-stat" id="ln-status-msg" style="margin-left:auto;"></div>
    </div>

    <!-- Â∑•ÂÖ∑ÊèêÁ§∫ -->
    <div class="ln-tooltip" id="ln-tooltip"></div>
</section>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     Âå∫Âüü ‚ë¢ ‚Äî Ë¥ùÈòôÔºàÂÖ®ËóèÁõÆÂΩïÊµèËßàÔºâ
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<section class="content-section" id="catalog-section" x-data="catalogApp()">
    <div class="section-header">
        <h2 class="section-title">
            <div class="section-icon icon-zang" title="Ëóè"></div>
            Ë≤ùÈóï
            <span class="section-subtitle">Ê≠£Ê≥ï‰πÖ‰Ωè</span>
        </h2>
    </div>

    <!-- Tab ÂàáÊç¢ + ÊêúÁ¥¢Ê°Ü -->
    <div class="catalog-toolbar">
        <div class="catalog-tabs">
            <button class="catalog-tab" :class="activeTab === 'bulei' ? 'active' : ''" @click="switchTab('bulei')"><i
                    data-lucide="layers"
                    style="width:14px;height:14px;vertical-align:-2px;margin-right:4px"></i>ÈÉ®È°û</button>
            <button class="catalog-tab" :class="activeTab === 'canon' ? 'active' : ''" @click="switchTab('canon')"><i
                    data-lucide="library"
                    style="width:14px;height:14px;vertical-align:-2px;margin-right:4px"></i>Á∂ìËóè</button>
        </div>
        <div class="catalog-search-box">
            <span class="catalog-search-icon"><i data-lucide="search" style="width:14px;height:14px"></i></span>
            <input type="text" class="catalog-search-input" placeholder="Âú®ÁõÆÈåÑ‰∏≠ÊêúÂ∞ãÁ∂ìÂêç‚Ä¶" x-model="filterQuery"
                @input.debounce.200ms="applyFilter()">
            <button class="catalog-search-clear" x-show="filterQuery.length > 0" x-cloak
                @click="filterQuery = ''; applyFilter()">‚úï</button>
        </div>
        <span class="catalog-stat" x-show="loaded" x-cloak x-text="statText"></span>
    </div>

    <!-- ÁõÆÂΩïÊ†ë -->
    <div class="catalog-tree" x-show="loaded" x-cloak>
        <template x-if="filteredTree.length === 0 && filterQuery.length > 0">
            <div class="catalog-empty">Êú™ÊâæÂà∞Áõ∏Á¨¶ÁöÑÁ∂ìÊñá</div>
        </template>
        <template x-for="(node, i) in filteredTree" :key="i">
            <div class="catalog-branch">
                <!-- È°∂Á∫ßÂàÜÁ±ªÊ†áÈ¢ò -->
                <button class="catalog-l1-header" @click="toggleL1(i)" :class="openL1.has(i) ? 'is-open' : ''">
                    <span class="catalog-toggle" x-text="openL1.has(i) ? '‚ñæ' : '‚ñ∏'"></span>
                    <span class="catalog-l1-title" x-text="node.title"></span>
                    <span class="catalog-l1-count" x-text="countLeaves(node) + ' ÈÉ®'"
                        x-show="countLeaves(node) > 0"></span>
                </button>
                <!-- Â≠êËäÇÁÇπÔºàÈÄíÂΩíÔºâ -->
                <div class="catalog-l1-body" x-show="openL1.has(i)" x-cloak>
                    <template x-for="(child, j) in node.children" :key="j">
                        <div>
                            <!-- ÊúâÂ≠êËäÇÁÇπ = ÂèØÊäòÂè†ÁõÆÂΩï -->
                            <template x-if="child.children && child.children.length > 0">
                                <div class="catalog-subgroup">
                                    <button class="catalog-l2-header" @click="toggleSub(i + '-' + j)"
                                        :class="openSub.has(i + '-' + j) ? 'is-open' : ''">
                                        <span class="catalog-toggle-sm"
                                            x-text="openSub.has(i + '-' + j) ? '‚ñæ' : '‚ñ∏'"></span>
                                        <span x-text="child.title"></span>
                                        <span class="catalog-l2-count" x-text="countLeaves(child) + ' ÈÉ®'"
                                            x-show="countLeaves(child) > 0"></span>
                                    </button>
                                    <div class="catalog-l2-body" x-show="openSub.has(i + '-' + j)" x-cloak>
                                        <template x-for="(leaf, k) in child.children" :key="k">
                                            <div>
                                                <!-- Á¨¨‰∏âÂ±Ç‰πüÂèØËÉΩÊúâÂ≠êËäÇÁÇπ -->
                                                <template
                                                    x-if="leaf.children && leaf.children.length > 0 && !leaf.sutra_id">
                                                    <div class="catalog-subgroup">
                                                        <button class="catalog-l3-header"
                                                            @click="toggleSub(i + '-' + j + '-' + k)"
                                                            :class="openSub.has(i + '-' + j + '-' + k) ? 'is-open' : ''">
                                                            <span class="catalog-toggle-sm"
                                                                x-text="openSub.has(i + '-' + j + '-' + k) ? '‚ñæ' : '‚ñ∏'"></span>
                                                            <span x-text="leaf.title"></span>
                                                            <span class="catalog-l2-count"
                                                                x-text="countLeaves(leaf) + ' ÈÉ®'"
                                                                x-show="countLeaves(leaf) > 0"></span>
                                                        </button>
                                                        <div class="catalog-l3-body"
                                                            x-show="openSub.has(i + '-' + j + '-' + k)" x-cloak>
                                                            <template x-for="(item, m) in leaf.children" :key="m">
                                                                <a class="catalog-leaf"
                                                                    :href="item.sutra_id ? '/read/' + item.sutra_id : '#'"
                                                                    x-show="item.sutra_id">
                                                                    <span class="catalog-leaf-id"
                                                                        x-text="item.sutra_id"></span>
                                                                    <span class="catalog-leaf-title"
                                                                        x-text="extractTitle(item.title)"></span>
                                                                </a>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </template>
                                                <!-- Âè∂Â≠êÁªèÊñáÊù°ÁõÆ -->
                                                <template x-if="leaf.sutra_id">
                                                    <a class="catalog-leaf" :href="'/read/' + leaf.sutra_id">
                                                        <span class="catalog-leaf-id" x-text="leaf.sutra_id"></span>
                                                        <span class="catalog-leaf-title"
                                                            x-text="extractTitle(leaf.title)"></span>
                                                    </a>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                            <!-- Âè∂Â≠êËäÇÁÇπÔºàÁõ¥Êé•ÁªèÊñáÔºâ -->
                            <template x-if="child.sutra_id && (!child.children || child.children.length === 0)">
                                <a class="catalog-leaf" :href="'/read/' + child.sutra_id">
                                    <span class="catalog-leaf-id" x-text="child.sutra_id"></span>
                                    <span class="catalog-leaf-title" x-text="extractTitle(child.title)"></span>
                                </a>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </template>
    </div>

    <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
    <div class="catalog-loading" x-show="!loaded">
        <span class="catalog-spinner"></span> ËºâÂÖ•ÁõÆÈåÑ‚Ä¶
    </div>
</section>

{% endblock %}