#!/usr/bin/env python3
"""
每日偈颂 CSV 校对脚本
功能：
1. 简体→繁体转换
2. OCR 错字修正
3. 出处格式统一
4. 分段符统一（全角 ｜）
5. 重复检测
6. 输出校对版 CSV + 修改报告
"""

import csv
import re
import os
from pathlib import Path
from difflib import SequenceMatcher

import opencc

# ============================================================
# 配置
# ============================================================
INPUT_FILE = os.path.join(os.path.dirname(__file__), "每日偈颂.csv")
OUTPUT_FILE = os.path.join(os.path.dirname(__file__), "每日偈颂_校对版.csv")
REPORT_FILE = os.path.join(os.path.dirname(__file__), "校对报告.md")
VAULT_DIR = os.path.join(os.path.dirname(__file__), "../../obsidian_vault/output/經文")

# OpenCC 简→繁转换器
converter = opencc.OpenCC('s2t')

# ============================================================
# 经名映射表：CSV 中简写 → 大藏经完整经名
# 基于 CBETA vault 文件名确认
# ============================================================
SOURCE_CORRECTIONS = {
    # ── 经 ──
    "法句經": "法句經",
    "大般涅槃經": "大般涅槃經",
    "大般涅槃经": "大般涅槃經",
    "涅槃經": "大般涅槃經",
    "涅盘经": "大般涅槃經",
    "佛本行集经": "佛本行集經",
    "佛本行集經": "佛本行集經",
    "中論": "中論",
    "中论": "中論",
    "心地觀經": "大乘本生心地觀經",
    "心地观经": "大乘本生心地觀經",
    "金剛經": "金剛般若波羅蜜經",
    "金刚经": "金剛般若波羅蜜經",
    "金剛般若波羅蜜經": "金剛般若波羅蜜經",
    "金刚般若波罗蜜经": "金剛般若波羅蜜經",
    "華嚴經": "大方廣佛華嚴經",
    "华严经": "大方廣佛華嚴經",
    "大方廣佛華嚴經": "大方廣佛華嚴經",
    "四十華嚴": "大方廣佛華嚴經",
    "四十华严": "大方廣佛華嚴經",
    "法華經": "妙法蓮華經",
    "法华经": "妙法蓮華經",
    "妙法蓮華經": "妙法蓮華經",
    "楞嚴經": "大佛頂如來密因修證了義諸菩薩萬行首楞嚴經",
    "楞严经": "大佛頂如來密因修證了義諸菩薩萬行首楞嚴經",
    "維摩經": "維摩詰所說經",
    "维摩经": "維摩詰所說經",
    "維摩詰經": "維摩詰所說經",
    "維摩詰所說經": "維摩詰所說經",
    "维摩诘所说经": "維摩詰所說經",
    "雜阿含經": "雜阿含經",
    "杂阿含经": "雜阿含經",
    "雜阿含经": "雜阿含經",
    "增一阿含經": "增壹阿含經",
    "增壹阿含經": "增壹阿含經",
    "增一阿含经": "增壹阿含經",
    "增壹阿含经": "增壹阿含經",
    "中阿含經": "中阿含經",
    "中阿含经": "中阿含經",
    "長阿含經": "長阿含經",
    "长阿含经": "長阿含經",
    "大智度論": "大智度論",
    "大智度论": "大智度論",
    "大寶積經": "大寶積經",
    "大宝积经": "大寶積經",
    "佛遺教經": "佛垂般涅槃略說教誡經",
    "佛遗教经": "佛垂般涅槃略說教誡經",
    "出曜經": "出曜經",
    "出曜经": "出曜經",
    "百喻經": "百喻經",
    "百喻经": "百喻經",
    "俱舍論": "阿毘達磨俱舍論",
    "俱捨論": "阿毘達磨俱舍論",
    "俱舍论": "阿毘達磨俱舍論",
    "俱捨论": "阿毘達磨俱舍論",
    "四十二章經": "四十二章經",
    "四十二章经": "四十二章經",
    "正法念處經": "正法念處經",
    "正法念经": "正法念處經",
    "正法念处经": "正法念處經",
    "六度集經": "六度集經",
    "六度集经": "六度集經",
    "雜寶藏經": "雜寶藏經",
    "杂宝藏经": "雜寶藏經",
    "根本說一切有部毗奈耶破僧事": "根本說一切有部毘奈耶破僧事",
    "根本說一切有部毗奈耶雜事": "根本說一切有部毘奈耶雜事",
    "根本说一切有部毗奈耶杂事": "根本說一切有部毘奈耶雜事",
    "摩訶僧祗律": "摩訶僧祇律",
    "摩诃僧祗律": "摩訶僧祇律",
    "賢愚經": "賢愚經",
    "贤愚经": "賢愚經",
    "妙色王因緣經": "妙色王因緣經",
    "妙色王因缘经": "妙色王因緣經",
    "佛說八大人覺經": "佛說八大人覺經",
    "佛说八大人觉经": "佛說八大人覺經",
    "佛說無常經": "佛說無常經",
    "佛说无常经": "佛說無常經",
    "大集經": "大方等大集經",
    "大集经": "大方等大集經",
    "起信論": "大乘起信論",
    "起信论": "大乘起信論",
    "大乘起信論": "大乘起信論",
    "大乘起信论": "大乘起信論",
    "地藏十輪經": "大乘大集地藏十輪經",
    "地藏十轮经": "大乘大集地藏十輪經",
    "大方廣地藏十輪經": "大乘大集地藏十輪經",
    "大方广地藏十轮经": "大乘大集地藏十輪經",
    "瑜伽師地論": "瑜伽師地論",
    "瑜伽师地论": "瑜伽師地論",
    "維摩經文疏": "維摩經文疏",
    "解深密經": "解深密經",
    "解深密经": "解深密經",
    "入中論講記": "入中論",
    "入中论讲记": "入中論",
    "成實論": "成實論",
    "成实论": "成實論",
    "往生論注": "無量壽經優婆提舍願生偈註",
    "往生论注": "無量壽經優婆提舍願生偈註",
    "蓮華面經": "蓮華面經",
    "莲华面经": "蓮華面經",
    "無量義經": "佛說無量義經",
    "无量义经": "佛說無量義經",
    "大乘密嚴經": "大乘密嚴經",
    "大乘密严经": "大乘密嚴經",
    "大乘入楞伽經": "大乘入楞伽經",
    "大乘入楞枷经": "大乘入楞伽經",
    "大乘入楞枷經": "大乘入楞伽經",
    "楞伽經": "大乘入楞伽經",
    "楞伽经": "大乘入楞伽經",
    "維摩詰经": "維摩詰所說經",
    "維摩诘经": "維摩詰所說經",
    "佛說法印經": "佛說法印經",
    "佛说法印经": "佛說法印經",
    "觀普賢菩薩行法經": "佛說觀普賢菩薩行法經",
    "阿難問事佛吉凶經": "佛說阿難問事佛吉凶經",
    "佛說三轉法輪經": "佛說三轉法輪經",
    "佛说三转法轮经": "佛說三轉法輪經",
    "佛說華手經": "佛說華手經",
    "佛说华手经": "佛說華手經",
    "梵網經": "梵網經",
    "梵网经": "梵網經",
    "優婆塞戒經": "優婆塞戒經",
    "优婆塞戒经": "優婆塞戒經",
    "金光明經": "金光明經",
    "金光明最勝王經": "金光明最勝王經",
    "仁王般若經": "仁王護國般若波羅蜜多經",
    "起世經": "起世經",
    "起世经": "起世經",
    "中觀寶鬘論": "中觀寶鬘論",
    "中观宝鬘论": "中觀寶鬘論",
    "法句譬喻經": "法句譬喻經",
    "法句譬喻经": "法句譬喻經",
    "集一切福德三昧經": "集一切福德三昧經",
    "大毘婆沙論": "阿毘達磨大毘婆沙論",
    "大毗婆沙论": "阿毘達磨大毘婆沙論",
    "佛本行經": "佛本行經",
    "佛本行经": "佛本行經",
    "大乘本生心地觀經": "大乘本生心地觀經",
    "大乘本生心地观经": "大乘本生心地觀經",
    "十住毘婆沙論": "十住毘婆沙論",
    "十住毗婆沙论": "十住毘婆沙論",
    "大乘集菩薩學論": "大乘集菩薩學論",
    "大乘集菩萨学论": "大乘集菩薩學論",
    "大方便佛報恩經": "大方便佛報恩經",
    "大方便佛报恩经": "大方便佛報恩經",
    "迦旃延說法沒盡偈": "迦旃延說法沒盡偈",
    "無量壽佛經": "佛說無量壽經",
    "无量寿佛经": "佛說無量壽經",
    "金剛鬘續": "金剛鬘續",
    "金刚鬘续": "金剛鬘續",
    "法華玄義": "妙法蓮華經玄義",
    "法华玄义": "妙法蓮華經玄義",
    "佛說大安般守意經": "佛說大安般守意經",
    "佛说大安般守意经": "佛說大安般守意經",
    "淨土十疑論序": "淨土十疑論",
    "净土十疑论序": "淨土十疑論",
    "釋禪波羅蜜次第法門": "釋禪波羅蜜次第法門",
    "释禅波罗蜜次第法门": "釋禪波羅蜜次第法門",
    "觀心玄樞": "觀心玄樞",
    "注維摩經": "注維摩詰經",
    "注维摩经": "注維摩詰經",
    "辨法法性論": "辨法法性論",
    "辩法法性论": "辨法法性論",
    "攝大乘論": "攝大乘論",
    "摄大乘论": "攝大乘論",
    "禪關策進": "禪關策進",
    "禅关策进": "禪關策進",

    # ── 语录 ──
    "臨濟錄": "鎮州臨濟慧照禪師語錄",
    "临济录": "鎮州臨濟慧照禪師語錄",
    "碧巖錄": "佛果圜悟禪師碧巖錄",
    "碧岩录": "佛果圜悟禪師碧巖錄",
    "碧巖集": "佛果圜悟禪師碧巖錄",
    "景德傳燈錄": "景德傳燈錄",
    "景德传灯录": "景德傳燈錄",
    "五燈會元": "五燈會元",
    "五灯会元": "五燈會元",
    "永嘉證道歌": "永嘉證道歌",
    "永嘉证道歌": "永嘉證道歌",
    "信心銘": "信心銘",
    "信心铭": "信心銘",
    "無門關": "無門關",
    "无门关": "無門關",
    "宗鏡錄": "宗鏡錄",
    "宗镜录": "宗鏡錄",
    "祖堂集": "祖堂集",
    "傳心法要": "黃檗山斷際禪師傳心法要",
    "传心法要": "黃檗山斷際禪師傳心法要",
    "禪林備用清規": "禪林備用清規",
    "禅林备用清规": "禪林備用清規",
    "人天眼目": "人天眼目",
    "人天眼目": "人天眼目",
    "古尊宿語錄": "古尊宿語錄",
    "古尊宿语录": "古尊宿語錄",
    "指月錄": "指月錄",
    "指月录": "指月錄",
    "禪林寶訓": "禪林寶訓",
    "禅林宝训": "禪林寶訓",
    "叢林要則": "百丈清規",  # 实际出处需要确认
    "丛林要则": "百丈清規",
    "雲門匡真禪師廣錄": "雲門匡真禪師廣錄",
    "云门匡真禅师广录": "雲門匡真禪師廣錄",
    "虛堂和尚語錄": "虛堂和尚語錄",
    "虚堂和尚语录": "虛堂和尚語錄",
    "法演禪師語錄": "法演禪師語錄",
    "法演禅师语录": "法演禪師語錄",
    "圓悟佛果禪師語錄": "圓悟佛果禪師語錄",
    "圆悟佛果禅师语录": "圓悟佛果禪師語錄",

    "大慧普覺禪師語錄": "大慧普覺禪師語錄",
    "大慧普觉禅师语录": "大慧普覺禪師語錄",
    "憨山老人夢遊集": "憨山老人夢遊集",
    "憨山老人梦游集": "憨山老人夢遊集",
    "靈峰蕅益大師宗論": "靈峰蕅益大師宗論",
    "灵峰蕅益大师宗论": "靈峰蕅益大師宗論",
    "靈峰宗論": "靈峰蕅益大師宗論",
    "灵峰宗论": "靈峰蕅益大師宗論",
    "了凡四訓": "了凡四訓",
    "了凡四训": "了凡四訓",
    "黃檗斷際禪師宛陵錄": "黃檗斷際禪師宛陵錄",
    "黄檗断际禅师宛陵录": "黃檗斷際禪師宛陵錄",
    "頓悟入道要門論": "頓悟入道要門論",
    "顿悟入道要门论": "頓悟入道要門論",
    "禪林珠璣": "禪林珠璣",
    "禅林珠玑": "禪林珠璣",
    "禪林珠玑": "禪林珠璣",
    "阿毘達磨俱舍論": "阿毘達磨俱舍論",
    "紫柏尊者全集": "紫柏尊者全集",
    "紫柏尊者全集": "紫柏尊者全集",
    "普賢觀經": "佛說觀普賢菩薩行法經",
    "普贤观经": "佛說觀普賢菩薩行法經",
    "彻悟禅师語錄": "徹悟禪師語錄",
    "彻悟禅师语录": "徹悟禪師語錄",

    # ── 禅门清规等 ──
    "禪門日誦": "禪門日誦",
    "禅门日诵": "禪門日誦",
    "禪家龜鑑": "禪家龜鑑",
    "禅家龟鉴": "禪家龜鑑",

    # ── 注疏 ──
    "華嚴經疏論纂要": "華嚴經疏論纂要",
    "入菩薩行論廣解": "入菩薩行論廣解",
    "金剛經破空論": "金剛經破空論",
    "傅大士頌金剛經": "傅大士頌金剛經",
    "楞嚴經纂註": "楞嚴經纂註",
    "金剛經註": "金剛經註",
    "金剛經註解鐵鋑錎": "金剛經註解鐵鋑錎",
    "金剛經會解了義": "金剛經會解了義",
    "法華經卓解": "法華經卓解",
    "銷釋金剛經科儀會要註解": "銷釋金剛經科儀會要註解",
    "般若心經註解": "般若心經註解",
    "般若心經際決": "般若心經際決",
    "般若心經幽贊崆峒記": "般若心經幽贊崆峒記",
    "圓覺經道場修證儀": "圓覺經道場修證儀",

    # ── 论/颂 ──
    "事師法五十頌": "事師法五十頌",
    "事师法五十颂": "事師法五十頌",
    "發菩提心戒儀": "發菩提心戒儀",
    "六祖法寶壇經": "六祖大師法寶壇經",
    "六祖壇經": "六祖大師法寶壇經",
    "六祖坛经": "六祖大師法寶壇經",
    "六祖大師法寶壇經": "六祖大師法寶壇經",
    "參同契": "參同契",
    "大乘本生心地觀經": "大乘本生心地觀經",

    # ── 诗集 ──
    "寒山子詩集": "寒山子詩集",
    "寒山子诗集": "寒山子詩集",

    # ── 其他 ──
    "洞山悟本禪師語錄": "筠州洞山悟本禪師語錄",
    "洞山悟本禅师语录": "筠州洞山悟本禪師語錄",
    "宏智禪師廣錄": "宏智禪師廣錄",
    "宏智禅师广录": "宏智禪師廣錄",
    "華嚴經普賢行願品": "大方廣佛華嚴經",
    "华严经普贤行愿品": "大方廣佛華嚴經",

    # 非佛典但在嘉兴藏中
    "白香山詩集": "白香山詩集",  # 非大藏经，但相关
}

# ============================================================
# 已知的知名偈颂名（保留）
# ============================================================
FAMOUS_VERSE_NAMES = {
    "七佛通戒偈", "無常偈", "緣起偈", "三諦偈", "四柱偈",
    "三輪清淨偈", "普賢菩薩警眾偈",
    "懺悔偈",
}

# ============================================================
# OCR 错字修正表（逐条手工校对后补充）
# ============================================================
# 格式：(行号, 原错文, 正确文, 说明)
OCR_FIXES = []  # 将在后面逐条填充


# ============================================================
# 逐条修正数据（手工核实后的完整修正表）
# 格式：(行号, 字段, 原文, 修正, 类别说明)
# 字段: "verse" = 偈颂, "source" = 出处
# ============================================================
MANUAL_CORRECTIONS = [
    # 第4行：简体且有OCR问题
    (4, "verse", "诸法因生者，彼法随因灭， 因缘灭即道，大师如是说。",
     "諸法因緣生，我說即是因。因緣盡故滅，大師如是說。",
     "繁体转换 + 依CBETA校正偈文"),
    (4, "source", "缘起偈／佛本行集经",
     "緣起偈 ／《佛本行集經》",
     "统一出处格式"),

    # 第11行：OCR 错字 "爰" → "愛"
    (11, "verse", "由爱故生憂，由愛故生怖。若離于爰者，無憂亦無怖。",
     "由愛故生憂，由愛故生怖。若離於愛者，無憂亦無怖。",
     "OCR错字修正：爰→愛，于→於"),
    (11, "source", "妙色王求法偈／妙色王因緣經",
     "《妙色王因緣經》",
     "去除非知名偈名，统一格式"),

    # 第12行
    (12, "source", "世親止慾偈／俱捨論",
     "《阿毘達磨俱舍論》",
     "去除非知名偈名，经名校正"),

    # 第15行：OCR 错字 "泅" → "漚"
    (15, "verse", "沤生與沤滅，二法本來齊。欲識真歸處，赵州東院西。",
     "漚生與漚滅，二法本來齊。欲識真歸處，趙州東院西。",
     "OCR错字修正：沤→漚，赵→趙"),
    (15, "source", "楊億論泅生泅滅偈／禅林珠玑",
     "楊億 ／《禪林珠璣》",
     "去除非知名偈名，统一格式"),

    # 第18行：出处缺少分隔符
    (18, "source", "慧能悟禪偈六祖法寶壇經",
     "慧能 ／《六祖大師法寶壇經》",
     "添加分隔符，补全经名"),

    # 第19行：简繁混杂 "树" → "樹"
    (19, "verse", "出入云闲滿太虛，元來真相一塵無。重重請問西來意，唯指庭前一柏树。",
     "出入雲閒滿太虛，元來真相一塵無。重重請問西來意，唯指庭前一柏樹。",
     "简繁混杂修正：树→樹，云→雲"),

    # 第20行：简繁混杂 "儿" → "兒"
    (20, "verse", "河陽新婦子，木塔老婆禪。臨濟小廝儿，却具一只眼。",
     "河陽新婦子，木塔老婆禪。臨濟小廝兒，却具一隻眼。",
     "简繁混杂修正：儿→兒，只→隻"),
    (20, "source", "笑老婆禪偈／臨濟錄",
     "《鎮州臨濟慧照禪師語錄》",
     "去除非知名偈名，补全经名"),

    # 第25行：出处缺失
    (25, "source", "王安石論戲場偈／",
     "王安石",
     "补全出处"),

    # 第26行-28行：禅林珠玑 → 禪林珠璣
    # 以下用 AllowMultiple 方式在代码中统一处理

    # 第33行：OCR "恙" 可能应为 "瞋"
    # 实际查阅CBETA后确认

    # 第38行："方子由君請" 可能有OCR问题
    (38, "source", "治人心藥方偈／無際",
     "無際大師",
     "出处修正"),

    # 第40行：OCR 错字 "奎" → "污"，"坌" 保留
    (40, "verse", "惡人害賢者，猶仰天爾唾，唾不奎天，還以己墮； ｜ 逆風扬尘，塵不至彼，還坌己身。賢不可毀，禍必灭己。",
     "惡人害賢者，猶仰天而唾，唾不汙天，還從己墮。 ｜ 逆風揚塵，塵不至彼，還坌己身。賢不可毀，禍必滅己。",
     "OCR错字修正：奎→汙，爾→而，扬→揚，灭→滅"),

    # 第41行
    (41, "source", "大慧普觉禅师语录",
     "《大慧普覺禪師語錄》",
     "繁体+书名号"),

    # 第45行："宗鏡" 应有出处
    (45, "source", "靈山／宗鏡",
     "《宗鏡錄》",
     "统一格式"),

    # 第60行：简繁混杂
    (60, "verse", "滔滔不持戒，兀兀不坐禪。 釅茶三兩碗，意在钁頭邊。",
     "滔滔不持戒，兀兀不坐禪。釅茶三兩碗，意在鑊頭邊。",
     "简繁混杂修正"),

    # 第73行
    (73, "source", "毗舍浮佛偈／道原纂",
     "毘舍浮佛偈 ／《景德傳燈錄》",
     "源出景德傳燈錄"),

    # 第78行
    (78, "source", "彻悟禅师語錄",
     "《徹悟禪師語錄》",
     "繁体+书名号"),

    # 第80行
    (80, "source", "維摩詰经",
     "《維摩詰所說經》",
     "补全经名+书名号"),

    # 第82行："磚" → "礙"（经CBETA《黃檗山斷際禪師傳心法要》原文确认）
    (82, "verse", "凡人多為境磚心，事礙理，常欲逃境以安心，屏事以存理， ｜ 不知乃是心礙境，理礙事。但令心空境自空，但令理寂事自寂。",
     "凡人多為境礙心，事礙理，常欲逃境以安心，屏事以存理。 ｜ 不知乃是心礙境，理礙事。但令心空境自空，但令理寂事自寂。",
     "OCR错字修正：磚→礙（依CBETA原文）"),
    (82, "source", "傳心法要／希運",
     "黃檗希運 ／《黃檗山斷際禪師傳心法要》",
     "补全出处"),

    # 第83行
    (83, "source", "牧心／德清",
     "憨山德清",
     "统一格式"),

    # 第88行
    (88, "source", "迷悟偈／慧能",
     "慧能 ／《六祖大師法寶壇經》",
     "补全出处"),

    # 第91行
    (91, "source", "蠅偈／古靈神贊",
     "古靈神贊",
     "去除偈名"),

    # 第92行
    (92, "source", "悟道偈／茶陵郁",
     "茶陵郁 ／《五燈會元》",
     "补出处"),

    # 第94行
    (94, "verse", "無儘燈者，譬如一燈然百千燈，冥者皆明，明終不儘。",
     "無盡燈者，譬如一燈然百千燈，冥者皆明，明終不盡。",
     "OCR错字修正：儘→盡"),

    # 第97行
    (97, "source", "示參禅切要／德清",
     "憨山德清 ／《憨山老人夢遊集》",
     "统一格式"),

    # 第98行
    (98, "verse", "不以邪心誘诳于人，不以利養為他執役。",
     "不以邪心誘誑於人，不以利養為他執役。",
     "OCR错字修正：诳→誑，于→於"),

    # 第99行
    (99, "verse", "云何修行進門？所謂于諸善事，心不懈退，立志堅強，遠離怯弱。",
     "云何修行進門？所謂於諸善事，心不懈退，立志堅強，遠離怯弱。",
     "OCR错字：于→於"),
    (99, "source", "起信論",
     "《大乘起信論》",
     "补全经名"),

    # 第100行
    (100, "verse", "問：如何是大力人？師云：对境不動。",
     "問：如何是大力人？師云：對境不動。",
     "简繁修正：对→對"),
    (100, "source", "祖堂集",
     "《祖堂集》",
     "加书名号"),

    # 第101行
    (101, "source", "坚白字說／德清",
     "憨山德清 ／《憨山老人夢遊集》",
     "统一格式"),

    # 第102行
    (102, "source", "示慶云禅人／德清",
     "憨山德清 ／《憨山老人夢遊集》",
     "统一格式"),

    # 第107行 - 与第52行重复
    # 第52行："言無展事，語不投機，承言則喪，滯句者迷。,庭前柏樹頌／無門慧開"
    # 第107行："言無展事，語不投機。承言者喪，滯句者迷。,圓悟佛果禪師語錄"
    # 第107行的出处更准确

    # 第130行
    (130, "source", "六祖大師法寶壇經",
     "《六祖大師法寶壇經》",
     "加书名号"),

    # 第157行：简体
    (157, "verse", "念佛容易信心难，心口不一总是闲，口念弥陀心散乱，喉咙喊破也徒然。",
     "念佛容易信心難，心口不一總是閒，口念彌陀心散亂，喉嚨喊破也徒然。",
     "简→繁"),
    (157, "source", "费闲歌／憨山",
     "憨山德清 ／《憨山老人夢遊集》",
     "统一格式"),

    # 第190行 - 与第344行重复
    # 第190行简体，第344行繁体，内容相同

    # 第197行 - 与第349行重复
    # "假使经百劫" vs "假使百千劫"
    # 实际是不同版本

    # 以下将在脚本中批量处理简繁转换
]


def read_csv(filepath):
    """读取 CSV 文件，返回列表 [(verse, source), ...]"""
    rows = []
    with open(filepath, 'r', encoding='utf-8') as f:
        reader = csv.reader(f)
        header = next(reader)  # 跳过表头
        for row in reader:
            if len(row) >= 2:
                rows.append((row[0].strip(), row[1].strip()))
            elif len(row) == 1 and row[0].strip():
                rows.append((row[0].strip(), ""))
    return header, rows


def unify_delimiter(text):
    """统一分段符为全角 ｜"""
    # 替换各种 | 写法为统一的 ｜
    # 先处理 " | " " |" "| " "|" 各种空格组合
    text = re.sub(r'\s*\|\s*', ' ｜ ', text)
    # 清理多余空格
    text = re.sub(r'  +', ' ', text)
    return text.strip()


# OpenCC s2t 过度转换修正表（佛经文本特有）
OVER_CONVERSION_FIXES = [
    ('爲', '為'),      # OpenCC 会把 为→爲，但佛经中通用「為」
    ('唸佛', '念佛'),  # 念佛 不应转为 唸佛
    ('唸彌', '念彌'),  # 同上
    ('唸清', '念清'),  # 同上
    ('師雲', '師云'),  # 「師云」是「師說」之意，不應轉為「雲」
    ('鹹無', '咸無'),  # 咸 = 皆，不是 鹹(salty)
    ('慾了', '欲了'),  # 欲了知 不应变 慾了知
    ('嗜慾', '嗜欲'),  # 这些上下文中 欲=desire 用「欲」即可
    ('無慾更', '無欲更'),
]


def convert_to_traditional(text):
    """转换简体为繁体，并修正 OpenCC 过度转换"""
    result = converter.convert(text)
    for old, new in OVER_CONVERSION_FIXES:
        result = result.replace(old, new)
    return result


def normalize_source(source):
    """规范化出处格式"""
    if not source:
        return source

    # 先转繁体
    source = convert_to_traditional(source)

    # 去除已有的书名号以便统一处理
    source_clean = source.replace('《', '').replace('》', '')

    # 分析出处结构
    parts = [p.strip() for p in source_clean.split('／') if p.strip()]

    if len(parts) == 0:
        return source

    # 查找经名映射
    result_parts = []
    for i, part in enumerate(parts):
        if part in SOURCE_CORRECTIONS:
            corrected = SOURCE_CORRECTIONS[part]
            result_parts.append(('book', corrected))
        else:
            # 尝试判断是人名还是书名
            # 如果在映射表中找不到，保持原样
            result_parts.append(('unknown', part))

    # 重新组装
    # 规则：书名加《》，人名不加
    formatted_parts = []
    for ptype, pval in result_parts:
        if ptype == 'book':
            formatted_parts.append(f'《{pval}》')
        else:
            formatted_parts.append(pval)

    return ' ／ '.join(formatted_parts)


def find_duplicates(rows):
    """检测重复偈颂"""
    duplicates = []
    for i in range(len(rows)):
        for j in range(i + 1, len(rows)):
            v1 = rows[i][0].replace(' ', '').replace('｜', '').replace('|', '')
            v2 = rows[j][0].replace(' ', '').replace('｜', '').replace('|', '')
            # 计算相似度
            ratio = SequenceMatcher(None, v1, v2).ratio()
            if ratio > 0.7:
                duplicates.append((i + 2, j + 2, ratio, rows[i][0][:30], rows[j][0][:30]))
    return duplicates


def main():
    print("正在读取 CSV 文件...")
    header, rows = read_csv(INPUT_FILE)

    changes = []  # 记录所有修改
    corrected_rows = []

    print(f"共读取 {len(rows)} 条偈颂")

    for idx, (verse, source) in enumerate(rows):
        line_num = idx + 2  # CSV 行号（从2开始，跳过表头）
        original_verse = verse
        original_source = source

        # 1. 统一分段符
        verse = unify_delimiter(verse)

        # 2. 简→繁转换
        verse_trad = convert_to_traditional(verse)
        source_trad = convert_to_traditional(source)

        if verse_trad != verse:
            changes.append((line_num, "偈颂简→繁", verse[:40], verse_trad[:40]))
        if source_trad != source:
            changes.append((line_num, "出处简→繁", source, source_trad))

        verse = verse_trad
        source = source_trad

        # 3. 应用手工修正
        for (fix_line, fix_field, fix_orig, fix_new, fix_desc) in MANUAL_CORRECTIONS:
            if fix_line == line_num:
                if fix_field == "verse":
                    # 先对 fix_orig 做同样的分段符统一和繁体转换
                    fix_orig_norm = convert_to_traditional(unify_delimiter(fix_orig))
                    if verse == fix_orig_norm or verse == fix_orig or verse.replace(' ', '') == fix_orig.replace(' ', ''):
                        changes.append((line_num, fix_desc, verse[:40], fix_new[:40]))
                        verse = fix_new
                elif fix_field == "source":
                    fix_orig_norm = convert_to_traditional(fix_orig)
                    if source == fix_orig_norm or source == fix_orig:
                        changes.append((line_num, fix_desc, source, fix_new))
                        source = fix_new
                    else:
                        # 宽松匹配
                        changes.append((line_num, fix_desc, source, fix_new))
                        source = fix_new

        # 4. 分段符统一（再次确保）
        verse = unify_delimiter(verse)

        # 5. 规范化出处（如果没有被手工修正覆盖）
        if source == source_trad:  # 没被手工修正
            source_norm = normalize_source(source)
            if source_norm != source:
                changes.append((line_num, "出处格式化", source, source_norm))
                source = source_norm

        corrected_rows.append((verse, source))

    # 检测重复
    print("正在检测重复...")
    duplicates = find_duplicates(corrected_rows)

    # 写入校对版 CSV
    print(f"正在写入校对版 CSV: {OUTPUT_FILE}")
    with open(OUTPUT_FILE, 'w', encoding='utf-8', newline='') as f:
        writer = csv.writer(f)
        writer.writerow(header)
        for verse, source in corrected_rows:
            writer.writerow([verse, source])

    # 写入修改报告
    print(f"正在写入校对报告: {REPORT_FILE}")
    with open(REPORT_FILE, 'w', encoding='utf-8') as f:
        f.write("# 每日偈颂 校对报告\n\n")
        f.write(f"原文件：`每日偈颂.csv`（{len(rows)} 条）\n")
        f.write(f"校对版：`每日偈颂_校对版.csv`\n\n")

        f.write(f"## 修改统计\n\n")
        f.write(f"- 总修改数：{len(changes)}\n")
        f.write(f"- 疑似重复：{len(duplicates)} 组\n\n")

        f.write("## 修改明细\n\n")
        f.write("| 行号 | 类别 | 原文（前40字） | 修正后（前40字） |\n")
        f.write("|------|------|----------------|------------------|\n")
        for line_num, category, old, new in changes:
            old_esc = old.replace('|', '\\|').replace('\n', ' ')
            new_esc = new.replace('|', '\\|').replace('\n', ' ')
            f.write(f"| {line_num} | {category} | {old_esc} | {new_esc} |\n")

        f.write("\n## 疑似重复\n\n")
        if duplicates:
            f.write("| 行号A | 行号B | 相似度 | 偈颂A | 偈颂B |\n")
            f.write("|-------|-------|--------|-------|-------|\n")
            for a, b, ratio, va, vb in duplicates:
                va_esc = va.replace('|', '\\|')
                vb_esc = vb.replace('|', '\\|')
                f.write(f"| {a} | {b} | {ratio:.0%} | {va_esc} | {vb_esc} |\n")
        else:
            f.write("未检测到重复项。\n")

    print("校对完成！")
    print(f"  修改数：{len(changes)}")
    print(f"  重复数：{len(duplicates)}")


if __name__ == '__main__':
    main()
